// МОДУЛЬ ОБЪЕКТА ДОКУМЕНТА "ЗАКАЗНАРЯД"

Процедура ОбработкаПроведения(Отказ, Режим)
    
    // ===== ПРОВЕРКА ДАННЫХ =====
    Если Услуги.Количество() = 0 И Материалы.Количество() = 0 Тогда
        Сообщить("Ошибка: Нет ни услуг, ни материалов!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    // ===== ИНИЦИАЛИЗАЦИЯ ДВИЖЕНИЙ =====
    Движения.ОстаткиМатериалов.Записывать = Истина;
    Движения.Продажи.Записывать = Истина;
    
    // ===== 1. ОБРАБОТКА УСЛУГ =====
    Для Каждого ТекСтрокаУслуги Из Услуги Цикл
        
        // Проверка типа
        Если ТекСтрокаУслуги.Номенклатура.ВидНоменклатуры <> Перечисления.ВидыНоменклатуры.Услуга Тогда
            Сообщить("Ошибка: В услуги добавлен не услуга - " + ТекСтрокаУслуги.Номенклатура);
            Отказ = Истина;
            Возврат;
        КонецЕсли;
        
        // Движение в регистр Продажи
        Движение = Движения.Продажи.Добавить();
        Движение.Период = Дата;
        Движение.Номенклатура = ТекСтрокаУслуги.Номенклатура;
        Движение.Клиент = Клиент;
        Движение.Мастер = Мастер;
        Движение.Количество = ТекСтрокаУслуги.Количество;
        Движение.Выручка = ТекСтрокаУслуги.Сумма;
        Движение.Стоимость = 0;
        
    КонецЦикла;
    
    // ===== 2. ОБРАБОТКА МАТЕРИАЛОВ =====
    Для Каждого ТекСтрокаМатериала Из Материалы Цикл
        
        // Проверка типа
        Если ТекСтрокаМатериала.Материал.ВидНоменклатуры <> Перечисления.ВидыНоменклатуры.Материал Тогда
            Сообщить("Ошибка: В материалы добавлен не материал - " + ТекСтрокаМатериала.Материал);
            Отказ = Истина;
            Возврат;
        КонецЕсли;
        
        // Проверка склада
        Если ТекСтрокаМатериала.Склад = Неопределено Тогда
            Сообщить("Ошибка: Для материала не указан склад!");
            Отказ = Истина;
            Возврат;
        КонецЕсли;
        
        // 2.1. Движение в ОстаткиМатериалов (СПИСАНИЕ)
        Движение = Движения.ОстаткиМатериалов.Добавить();
        Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
        Движение.Период = Дата;
        Движение.Материал = ТекСтрокаМатериала.Материал;
        Движение.Склад = ТекСтрокаМатериала.Склад;
        Движение.Количество = ТекСтрокаМатериала.Количество;
        
        // 2.2. Движение в Продажи
        Движение = Движения.Продажи.Добавить();
        Движение.Период = Дата;
        Движение.Номенклатура = ТекСтрокаМатериала.Материал;
        Движение.Клиент = Клиент;
        Движение.Мастер = Мастер;
        Движение.Количество = ТекСтрокаМатериала.Количество;
        Движение.Выручка = ТекСтрокаМатериала.Сумма;
        Движение.Стоимость = ТекСтрокаМатериала.Сумма;
        
    КонецЦикла;
    
    Сообщить("Документ успешно проведен!");
    
КонецПроцедуры

// ===== ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ЦЕНЫ =====

Функция ПолучитьЦенуНоменклатуры(Номенклатура, ДатаЦены)
    
    Попытка
        // Запрос к регистру сведений "Цены"
        Запрос = Новый Запрос;
        Запрос.Текст = 
            "ВЫБРАТЬ ПЕРВЫЕ 1
            |    Цены.Цена КАК Цена
            |ИЗ
            |    РегистрСведений.Цены КАК Цены
            |ГДЕ
            |    Цены.Номенклатура = &Номенклатура
            |    И Цены.Период <= &ДатаЦены
            |УПОРЯДОЧИТЬ ПО
            |    Цены.Период УБЫВ";
        
        Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
        Запрос.УстановитьПараметр("ДатаЦены", ДатаЦены);
        
        Результат = Запрос.Выполнить();
        Если НЕ Результат.Пустой() Тогда
            Выборка = Результат.Выбрать();
            Если Выборка.Следующий() Тогда
                Возврат Выборка.Цена;
            КонецЕсли;
        КонецЕсли;
        
        // Если цены в регистре нет, пробуем поле в справочнике
        Попытка
            Возврат Номенклатура.Цена;
        Исключение
            // Если и в справочнике нет поля Цена
            Возврат 0;
        КонецПопытки;
        
    Исключение
        // В случае любой ошибки возвращаем 0
        Возврат 0;
    КонецПопытки;
    
КонецФункции

// ===== ОБРАБОТКА ПЕРЕД ЗАПИСЬЮ =====

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
    
    // === АВТОПОДСТАНОВКА ЦЕН И РАСЧЕТ СУММ ДЛЯ УСЛУГ ===
    Для Каждого СтрокаУслуги Из Услуги Цикл
        Если СтрокаУслуги.Номенклатура <> Неопределено Тогда
            // Подстановка цены если не заполнена
            Если НЕ ЗначениеЗаполнено(СтрокаУслуги.Цена) Или СтрокаУслуги.Цена = 0 Тогда
                Цена = ПолучитьЦенуНоменклатуры(СтрокаУслуги.Номенклатура, Дата);
                Если Цена > 0 Тогда
                    СтрокаУслуги.Цена = Цена;
                Иначе
                    СтрокаУслуги.Цена = 100; // Цена по умолчанию для услуг
                КонецЕсли;
            КонецЕсли;
            
            // Расчет суммы
            СтрокаУслуги.Сумма = СтрокаУслуги.Количество * СтрокаУслуги.Цена;
        КонецЕсли;
    КонецЦикла;
    
    // === АВТОПОДСТАНОВКА ЦЕН И РАСЧЕТ СУММ ДЛЯ МАТЕРИАЛОВ ===
    Для Каждого СтрокаМатериала Из Материалы Цикл
        Если СтрокаМатериала.Материал <> Неопределено Тогда
            // Подстановка цены если не заполнена
            Если НЕ ЗначениеЗаполнено(СтрокаМатериала.Цена) Или СтрокаМатериала.Цена = 0 Тогда
                Цена = ПолучитьЦенуНоменклатуры(СтрокаМатериала.Материал, Дата);
                Если Цена > 0 Тогда
                    СтрокаМатериала.Цена = Цена;
                Иначе
                    СтрокаМатериала.Цена = 50; // Цена по умолчанию для материалов
                КонецЕсли;
            КонецЕсли;
            
            // Расчет суммы
            СтрокаМатериала.Сумма = СтрокаМатериала.Количество * СтрокаМатериала.Цена;
        КонецЕсли;
    КонецЦикла;
    
    // === РАСЧЕТ ИТОГОВОЙ СУММЫ ===
    ИтогСумма = 0;
    
    Для Каждого СтрокаУслуги Из Услуги Цикл
        ИтогСумма = ИтогСумма + СтрокаУслуги.Сумма;
    КонецЦикла;
    
    Для Каждого СтрокаМатериала Из Материалы Цикл
        ИтогСумма = ИтогСумма + СтрокаМатериала.Сумма;
    КонецЦикла;
    
    ИтоговаяСумма = ИтогСумма;
    
    // === УСТАНОВКА СТАТУСА ===
    Если Статус = Неопределено Тогда
        Статус = Перечисления.СтатусыЗаказа.Принят;
    КонецЕсли;
    
КонецПроцедуры